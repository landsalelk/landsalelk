name: Deploy to Appwrite

on:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Install Dependencies
        run: npm install

      - name: Install Appwrite CLI
        run: npm install -g appwrite-cli

      - name: Deploy to Appwrite
        env:
          APPWRITE_ENDPOINT: ${{ secrets.APPWRITE_ENDPOINT }}
          APPWRITE_PROJECT_ID: ${{ secrets.APPWRITE_PROJECT_ID }}
          APPWRITE_API_KEY: ${{ secrets.APPWRITE_API_KEY }}
        run: |
          # Use secrets if available, otherwise fallback to values from appwrite.json or known defaults
          # Note: API KEY MUST be in secrets for security.
          
          ENDPOINT="${APPWRITE_ENDPOINT:-https://sgp.cloud.appwrite.io/v1}"
          PROJECT_ID="${APPWRITE_PROJECT_ID:-landsalelkproject}"
          
          if [ -z "$APPWRITE_API_KEY" ]; then
            echo "❌ Error: APPWRITE_API_KEY secret is missing in GitHub Settings."
            exit 1
          fi

          # Configure Appwrite CLI for CI (non-interactive)
          appwrite client --endpoint "$ENDPOINT" --project-id "$PROJECT_ID" --key "$APPWRITE_API_KEY"
          
          # Cancel any currently processing builds to save resources
          echo "Checking for ongoing builds..."
          FUNCTIONS=$(appwrite functions list --json | jq -r '.functions[]."$id"')
          for FUNC_ID in $FUNCTIONS; do
            ONGOING_DEPLOYMENT=$(appwrite functions list-deployments --function-id $FUNC_ID --json | jq -r '.deployments[] | select(.status == "processing" or .status == "building") | ."$id"' | head -n 1)
            if [ ! -z "$ONGOING_DEPLOYMENT" ]; then
              echo "Cancelling ongoing build $ONGOING_DEPLOYMENT for function $FUNC_ID"
              appwrite functions update-deployment-status --function-id $FUNC_ID --deployment-id $ONGOING_DEPLOYMENT || true
            fi
          done
          
          # Deploy all resources (Functions, Sites, Collections, Buckets, etc.)
          echo "Deploying functions..."
          # Get functions explicitly defined in appwrite.json
          FUNCTIONS=$(jq -r '.functions[]."$id"' appwrite.json)
          for FUNC_ID in $FUNCTIONS; do
            echo "Pushing function: $FUNC_ID"
            appwrite push function --function-id $FUNC_ID --with-variables --force
          done
          
          echo "Deploying site..."
          appwrite push site --site-id 6941d9280032a28b0536 --force
          
          # Activate latest ready deployments
          FUNCTIONS=$(jq -r '.functions[]."$id"' appwrite.json)
          for FUNC_ID in $FUNCTIONS; do
            echo "Processing function: $FUNC_ID"
            LATEST_DEPLOYMENT=$(appwrite functions list-deployments --function-id $FUNC_ID --json | jq -r '.deployments[0]."$id" // ""')
            
            if [ ! -z "$LATEST_DEPLOYMENT" ]; then
              echo "Found latest deployment: $LATEST_DEPLOYMENT"
              
              # Poll for build completion (max 5 minutes)
              for i in {1..30}; do
                DEPLOYMENT_STATUS=$(appwrite functions get-deployment --function-id $FUNC_ID --deployment-id $LATEST_DEPLOYMENT --json | jq -r '.status')
                echo "Deployment status: $DEPLOYMENT_STATUS"
                
                if [ "$DEPLOYMENT_STATUS" = "ready" ]; then
                  appwrite functions update-function-deployment --function-id $FUNC_ID --deployment-id $LATEST_DEPLOYMENT
                  echo "✅ Activated deployment $LATEST_DEPLOYMENT"
                  break
                elif [ "$DEPLOYMENT_STATUS" = "failed" ]; then
                  echo "❌ Deployment $LATEST_DEPLOYMENT failed"
                  echo "Fetching build logs..."
                  # Attempt to fetch build logs (if supported via CLI, otherwise generic message)
                  appwrite functions get-deployment --function-id $FUNC_ID --deployment-id $LATEST_DEPLOYMENT --json || echo "Could not fetch deployment details"
                  exit 1
                fi
                
                if [ $i -eq 30 ]; then
                  echo "⚠️ Timeout waiting for deployment $LATEST_DEPLOYMENT"
                else
                  echo "Waiting for build to complete..."
                  sleep 10
                fi
              done
            else
              echo "No deployments found for function $FUNC_ID"
            fi
          done